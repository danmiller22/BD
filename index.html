import React, { useEffect, useMemo, useState } from "react";
import { motion } from "framer-motion";
import Papa from "papaparse";
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  LineChart,
  Line,
  Legend,
  BarChart,
  Bar,
} from "recharts";

const SHEET_ID = "1QiFjfGky5vNBPf9WCPNkvszjJXH9413GecYzioSO32Q";
const SHEET_GID = "1435752205";

function parseMoney(v) {
  if (v == null) return 0;
  const cleaned = String(v).replace(/[^0-9.\-]/g, "");
  const num = parseFloat(cleaned);
  return isNaN(num) ? 0 : num;
}

function monthKey(isoDate) {
  const d = new Date(isoDate);
  if (isNaN(d.getTime())) return "Unknown";
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
}

function niceMonthLabel(key) {
  if (key === "Unknown") return key;
  const [y, m] = key.split("-");
  const d = new Date(Number(y), Number(m) - 1, 1);
  return d.toLocaleString(undefined, { month: "short", year: "2-digit" });
}

function parseDateMs(v) {
  const t = Date.parse(v);
  return Number.isFinite(t) ? t : 0;
}

function runDevTests() {
  const eq = (a, b, msg) => {
    const ok = Math.abs(a - b) < 1e-6;
    if (!ok) console.error("TEST FAIL:", msg, { got: a, want: b });
  };
  const is = (cond, msg) => {
    if (!cond) console.error("TEST FAIL:", msg);
  };
  try {
    eq(parseMoney("$443.37"), 443.37, "parseMoney dollar");
    eq(parseMoney("1,420.00"), 1420.0, "parseMoney comma");
    eq(parseMoney("443"), 443, "parseMoney int");
    is(monthKey("2025-02-20").startsWith("2025-02"), "monthKey basic");
    is(niceMonthLabel("2025-02").length >= 3, "niceMonthLabel readable");
  } catch (e) {
    console.warn("Self-tests threw:", e);
  }
}
if (typeof window !== "undefined" && !window.__FLEET_TESTS_RAN__) {
  window.__FLEET_TESTS_RAN__ = true;
  runDevTests();
}

const Card = ({ children, className = "" }) => (
  <motion.div
    initial={{ opacity: 0, y: 16 }}
    animate={{ opacity: 1, y: 0 }}
    transition={{ duration: 0.6, ease: [0.22, 1, 0.36, 1] }}
    className={`rounded-2xl bg-white/10 dark:bg-white/10 backdrop-blur-xl border border-white/20 shadow-[inset_0_1px_0_rgba(255,255,255,0.2)] ${className}`}
  >
    {children}
  </motion.div>
);

const Stat = ({ label, value, sub }) => (
  <div className="p-5">
    <div className="text-sm text-white/70 tracking-wide">{label}</div>
    <div className="mt-1 text-3xl md:text-4xl font-semibold text-white">{value}</div>
    {sub ? <div className="mt-1 text-xs text-white/60">{sub}</div> : null}
  </div>
);

const GlassGradient = () => (
  <div className="absolute inset-0 -z-10 overflow-hidden">
    <div className="absolute -top-40 -right-32 h-80 w-80 rounded-full bg-gradient-to-br from-sky-300/40 to-indigo-400/30 blur-3xl" />
    <div className="absolute -bottom-28 -left-24 h-72 w-72 rounded-full bg-gradient-to-br from-cyan-300/40 to-blue-400/30 blur-3xl" />
  </div>
);

export default function FleetDashboard() {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    let cancelled = false;
    async function load() {
      const candidates = [
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}`,
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`,
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`,
      ];
      let lastErr = null;
      for (const url of candidates) {
        try {
          const res = await fetch(url, {
            mode: "cors",
            credentials: "omit",
            cache: "no-cache",
            headers: { Accept: "text/csv" },
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const text = await res.text();
          if (!text || text.trim().length === 0) throw new Error("Empty CSV");
          const parsed = Papa.parse(text, { header: true, dynamicTyping: false });
          const filtered = (parsed.data || []).filter(
            (r) => r && Object.values(r).some((x) => x && String(x).trim().length)
          );
          if (!cancelled) {
            setRows(filtered);
            setError(null);
            setLoading(false);
          }
          return;
        } catch (e) {
          lastErr = e;
        }
      }
      if (!cancelled) {
        setRows([]);
        setError(lastErr && lastErr.message ? lastErr.message : "Failed to fetch CSV");
        setLoading(false);
      }
    }
    load();
    return () => {
      cancelled = true;
    };
  }, []);

  const metrics = useMemo(() => {
    if (!rows?.length) return null;

    const meaningful = rows.filter((r) => {
      const totalOk = parseMoney(r["Total"]) > 0;
      const hasKey = ["Date", "Vendor", "Category", "Unit", "Type"].some((k) => r[k] && String(r[k]).trim().length);
      return totalOk || hasKey;
    });
    if (!meaningful.length) return null;

    const norm = (s) => String(s || "").trim().toLowerCase();
    const closedSet = new Set(["closed", "completed", "complete", "done", "resolved"]);

    const withStatus = meaningful.filter((r) => r["Status"] && String(r["Status"]).trim().length);
    const closedRows = withStatus.filter((r) => closedSet.has(norm(r["Status"])));
    const openRows = withStatus.filter((r) => !closedSet.has(norm(r["Status"])));

    const totalSpend = meaningful.reduce((acc, r) => acc + parseMoney(r["Total"]), 0);

    const byMonth = new Map();
    meaningful.forEach((r) => {
      const d = new Date(r["Date"]);
      if (isNaN(d.getTime())) return;
      const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
      const cur = byMonth.get(key) || { key, spend: 0, count: 0 };
      cur.spend += parseMoney(r["Total"]);
      cur.count += 1;
      byMonth.set(key, cur);
    });
    const monthSeries = Array.from(byMonth.values())
      .sort((a, b) => a.key.localeCompare(b.key))
      .map((m) => ({ name: niceMonthLabel(m.key), Spend: Number(m.spend.toFixed(2)), Jobs: m.count }));

    const byCategory = {};
    meaningful.forEach((r) => {
      const c = r["Category"] || "Uncategorized";
      byCategory[c] = (byCategory[c] || 0) + parseMoney(r["Total"]);
    });
    const categorySeries = Object.entries(byCategory)
      .map(([name, v]) => ({ name, value: Number(v.toFixed(2)) }))
      .sort((a, b) => b.value - a.value);

    const byVendor = {};
    meaningful.forEach((r) => {
      const v = r["Vendor"] || "Unknown";
      byVendor[v] = (byVendor[v] || 0) + parseMoney(r["Total"]);
    });
    const vendorSeries = Object.entries(byVendor)
      .map(([name, v]) => ({ name, value: Number(v.toFixed(2)) }))
      .sort((a, b) => b.value - a.value)
      .slice(0, 6);

    const byUnit = {};
    meaningful.forEach((r) => {
      const u = r["Unit"] || "Unknown";
      byUnit[u] = (byUnit[u] || 0) + 1;
    });
    const unitSeries = Object.entries(byUnit)
      .map(([name, v]) => ({ name, value: v }))
      .sort((a, b) => b.value - a.value)
      .slice(0, 10);

    const sortDesc = (a, b) => parseDateMs(b["Date"]) - parseDateMs(a["Date"]);

    return { totalSpend, open: openRows.length, closed: closedRows.length, monthSeries, categorySeries, vendorSeries, unitSeries, openRows: openRows.sort(sortDesc), closedRows: closedRows.sort(sortDesc) };
  }, [rows]);

  const currency = (n) => new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" }).format(n);

  return (
    <div className="min-h-screen bg-[#0B0F1A] text-white relative">
      <GlassGradient />
      <div className="w-full px-6 md:px-10 py-8 md:py-12">
        <header className="mb-8 md:mb-12">
          <motion.h1
            initial={{ opacity: 0, y: 12 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
            className="text-2xl md:text-4xl font-semibold tracking-tight"
          >
            US Team Fleet
          </motion.h1>
        </header>

        <style>{`
          .recharts-wrapper, .recharts-surface { background: transparent !important; }
          .recharts-tooltip-wrapper { filter: drop-shadow(0 6px 18px rgba(0,0,0,0.35)); }
        `}</style>

        {loading && <div className="text-white/70">Loading dataâ€¦</div>}
        {!loading && !rows.length && (
          <div className="text-red-300">{error || "No data"}</div>
        )}

        {!loading && metrics && (
          <div className="space-y-8">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <Card>
                <Stat label="Total Spend" value={currency(metrics.totalSpend)} sub="Sum of all jobs" />
              </Card>
              <Card>
                <Stat label="Jobs Closed" value={metrics.closed} sub="Completed work orders" />
              </Card>
              <Card>
                <Stat label="Jobs Open" value={metrics.open} sub="Active or pending" />
              </Card>
            </div>

            <Card className="p-6">
              <div className="mb-4 text-lg font-medium">Monthly Spend</div>
              <div className="h-64">
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={metrics.monthSeries} margin={{ top: 0, right: 0, left: 0, bottom: 0 }}>
                    <defs>
                      <linearGradient id="grad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#60A5FA" stopOpacity={0.9} />
                        <stop offset="100%" stopColor="#60A5FA" stopOpacity={0.05} />
                      </linearGradient>
                    </defs>
                    <XAxis dataKey="name" tick={{ fill: "#D1D5DB" }} axisLine={false} tickLine={false} />
                    <YAxis tick={{ fill: "#D1D5DB" }} axisLine={false} tickLine={false} width={72} />
                    <Tooltip contentStyle={{ background: "rgba(12,16,27,0.9)", border: "none", borderRadius: 12, color: "#E5E7EB" }} />
                    <Area type="monotone" dataKey="Spend" stroke="#93C5FD" strokeWidth={3} fill="url(#grad)" />
                    <Line type="monotone" dataKey="Jobs" stroke="#A7F3D0" strokeWidth={2} dot={false} />
                  </AreaChart>
                </ResponsiveContainer>
              </div>
            </Card>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <Card className="p-6">
                <div className="mb-4 text-lg font-medium">Spend by Category</div>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Tooltip contentStyle={{ background: "rgba(12,16,27,0.9)", border: "none", borderRadius: 12, color: "#E5E7EB" }} />
                      <Pie data={metrics.categorySeries} dataKey="value" nameKey="name" innerRadius={60} outerRadius={90} paddingAngle={3}>
                        {metrics.categorySeries.map((_, i) => (
                          <Cell key={i} fill={`hsl(${200 + i * 14}, 80%, 65%)`} />
                        ))}
                      </Pie>
                      <Legend wrapperStyle={{ color: "#E5E7EB" }} iconType="circle" />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
              </Card>

              <Card className="p-6 lg:col-span-2">
                <div className="mb-4 text-lg font-medium">Top Vendors</div>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={metrics.vendorSeries} margin={{ top: 0, right: 0, left: 0, bottom: 0 }}>
                      <XAxis dataKey="name" tick={{ fill: "#D1D5DB" }} axisLine={false} tickLine={false} interval={0} angle={-20} textAnchor="end" height={60} />
                      <YAxis tick={{ fill: "#D1D5DB" }} axisLine={false} tickLine={false} width={72} />
                      <Tooltip contentStyle={{ background: "rgba(12,16,27,0.9)", border: "none", borderRadius: 12, color: "#E5E7EB" }} />
                      <Line type="monotone" dataKey="value" stroke="#7DD3FC" strokeWidth={3} dot={{ r: 3 }} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </Card>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <Card className="p-6 md:col-span-2">
                <div className="mb-4 text-lg font-medium">Most Frequent Units (Breakdowns)</div>
                <div className="h-72">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={metrics.unitSeries} margin={{ top: 0, right: 0, left: 0, bottom: 0 }} barCategoryGap="20%" barGap={4}>
                      <XAxis dataKey="name" tick={{ fill: "#D1D5DB" }} axisLine={false} tickLine={false} interval={0} angle={-20} textAnchor="end" height={60} />
                      <YAxis domain={[0, (dataMax) => (typeof dataMax === 'number' ? dataMax + 1 : 1)]} tick={{ fill: "#D1D5DB" }} axisLine={false} tickLine={false} width={72} />
                      <Tooltip contentStyle={{ background: "rgba(12,16,27,0.9)", border: "none", borderRadius: 12, color: "#E5E7EB" }} />
                      <Bar dataKey="value" fill="#93C5FD" radius={[10,10,0,0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </Card>
            </div>

            <Card className="p-6">
              <div className="text-lg font-medium">Notes</div>
              <div className="mt-3 text-white/80 text-sm leading-6">
                Data updates automatically from your Google Sheet. Columns must match the specified headers.
              </div>
            </Card>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <Card className="p-6">
                <div className="mb-4 text-lg font-medium">Open Reports</div>
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead className="text-white/70">
                      <tr>
                        <th className="text-left pr-4 py-2">Date</th>
                        <th className="text-left pr-4 py-2">Unit</th>
                        <th className="text-left pr-4 py-2">Category</th>
                        <th className="text-left pr-4 py-2">Repair</th>
                        <th className="text-left pr-4 py-2">Vendor</th>
                        <th className="text-left pr-4 py-2">Total</th>
                        <th className="text-left pr-4 py-2">Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-white/10">
                      {metrics.openRows.map((r, idx) => (
                        <tr key={`o-${idx}`} className="hover:bg-white/5">
                          <td className="pr-4 py-2">{r["Date"]}</td>
                          <td className="pr-4 py-2">{r["Unit"]}</td>
                          <td className="pr-4 py-2">{r["Category"]}</td>
                          <td className="pr-4 py-2">{r["Repair"]}</td>
                          <td className="pr-4 py-2">{r["Vendor"]}</td>
                          <td className="pr-4 py-2">{currency(parseMoney(r["Total"]))}</td>
                          <td className="pr-4 py-2">{r["Status"]}</td>
                        </tr>
                      ))}
                      {metrics.openRows.length === 0 && (
                        <tr>
                          <td colSpan={7} className="py-4 text-white/60">No open reports</td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </Card>

              <Card className="p-6">
                <div className="mb-4 text-lg font-medium">Closed Reports</div>
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead className="text-white/70">
                      <tr>
                        <th className="text-left pr-4 py-2">Date</th>
                        <th className="text-left pr-4 py-2">Unit</th>
                        <th className="text-left pr-4 py-2">Category</th>
                        <th className="text-left pr-4 py-2">Repair</th>
                        <th className="text-left pr-4 py-2">Vendor</th>
                        <th className="text-left pr-4 py-2">Total</th>
                        <th className="text-left pr-4 py-2">Status</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-white/10">
                      {metrics.closedRows.map((r, idx) => (
                        <tr key={`c-${idx}`} className="hover:bg-white/5">
                          <td className="pr-4 py-2">{r["Date"]}</td>
                          <td className="pr-4 py-2">{r["Unit"]}</td>
                          <td className="pr-4 py-2">{r["Category"]}</td>
                          <td className="pr-4 py-2">{r["Repair"]}</td>
                          <td className="pr-4 py-2">{r["Vendor"]}</td>
                          <td className="pr-4 py-2">{currency(parseMoney(r["Total"]))}</td>
                          <td className="pr-4 py-2">{r["Status"]}</td>
                        </tr>
                      ))}
                      {metrics.closedRows.length === 0 && (
                        <tr>
                          <td colSpan={7} className="py-4 text-white/60">No closed reports</td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </Card>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
