<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>US Team Fleet</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#0B0F1A;color:#fff;overflow-x:hidden}
  .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.18);border-radius:16px;box-shadow:inset 0 1px 0 rgba(255,255,255,.2)}
  .card{padding:24px}
  .title{font-weight:600}
  .kpi{font-size:1.875rem;line-height:2.25rem}
  .sub{color:#cbd5e1}
  .shadow-soft{box-shadow:0 15px 40px rgba(0,0,0,.35)}
  .chart-wrap{position:relative;height:300px;overflow:hidden;border-radius:12px}
  @media (min-height:900px){ .chart-wrap{height:360px} }
  canvas{display:block;width:100%!important;height:100%!important}
  .screen{min-height:100vh;width:100%;padding:32px}
</style>
</head>
<body>
  <div class="screen">
    <header class="mb-8">
      <h1 class="text-2xl md:text-4xl title">US Team Fleet</h1>
    </header>

    <div id="status" class="text-white/70">Loading data…</div>

    <div id="content" class="space-y-8 hidden">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="glass card shadow-soft">
          <div class="text-sm text-white/70">Total Spend</div>
          <div id="kpi-spend" class="kpi mt-1">—</div>
          <div class="text-xs sub mt-1">Sum of all jobs</div>
        </div>
        <div class="glass card shadow-soft">
          <div class="text-sm text-white/70">Jobs Closed</div>
          <div id="kpi-closed" class="kpi mt-1">—</div>
          <div class="text-xs sub mt-1">Completed work orders</div>
        </div>
        <div class="glass card shadow-soft">
          <div class="text-sm text-white/70">Jobs Open</div>
          <div id="kpi-open" class="kpi mt-1">—</div>
          <div class="text-xs sub mt-1">Active or pending</div>
        </div>
      </div>

      <div class="glass card shadow-soft">
        <div class="mb-4 text-lg">Monthly Spend</div>
        <div class="chart-wrap"><canvas id="chart-month"></canvas></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="glass card shadow-soft">
          <div class="mb-4 text-lg">Spend by Category</div>
          <div class="chart-wrap"><canvas id="chart-cat"></canvas></div>
        </div>
        <div class="glass card lg:col-span-2 shadow-soft">
          <div class="mb-4 text-lg">Top Vendors</div>
          <div class="chart-wrap"><canvas id="chart-vendor"></canvas></div>
        </div>
      </div>

      <div class="glass card shadow-soft">
        <div class="mb-4 text-lg">Most Frequent Units (Breakdowns)</div>
        <div class="chart-wrap"><canvas id="chart-unit"></canvas></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass card shadow-soft">
          <div class="mb-4 text-lg">Open Reports</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-white/70">
                <tr>
                  <th class="text-left pr-4 py-2">Date</th><th class="text-left pr-4 py-2">Unit</th>
                  <th class="text-left pr-4 py-2">Category</th><th class="text-left pr-4 py-2">Repair</th>
                  <th class="text-left pr-4 py-2">Vendor</th><th class="text-left pr-4 py-2">Total</th>
                  <th class="text-left pr-4 py-2">Status</th>
                </tr>
              </thead>
              <tbody id="open-body" class="divide-y divide-white/10"></tbody>
            </table>
          </div>
        </div>

        <div class="glass card shadow-soft">
          <div class="mb-4 text-lg">Closed Reports</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-white/70">
                <tr>
                  <th class="text-left pr-4 py-2">Date</th><th class="text-left pr-4 py-2">Unit</th>
                  <th class="text-left pr-4 py-2">Category</th><th class="text-left pr-4 py-2">Repair</th>
                  <th class="text-left pr-4 py-2">Vendor</th><th class="text-left pr-4 py-2">Total</th>
                  <th class="text-left pr-4 py-2">Status</th>
                </tr>
              </thead>
              <tbody id="closed-body" class="divide-y divide-white/10"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const SHEET_ID="1QiFjfGky5vNBPf9WCPNkvszjJXH9413GecYzioSO32Q";
const SHEET_GID="1435752205";

const EXCLUDE = [
  { Date:"2025-11-04", Unit:"TRL 555 ( TRK 62 )", Vendor:"Love's", Total:"US$52.36", Status:"Closed" },
  { Unit:"TRK 008", Vendor:"Love's", Total:"US$168.16", Status:"Completed" },
  { Unit:"TRL 9835", Vendor:"TA", Total:"US$55.00", Status:"Completed" },
];
const eq = (a,b)=>String(a||"").trim()===String(b||"").trim();
const isExcluded = r => EXCLUDE.some(sig=>Object.entries(sig).every(([k,v])=>eq(r[k],v)));

const money=n=>new Intl.NumberFormat(undefined,{style:"currency",currency:"USD"}).format(n||0);
const parseMoney=v=>{if(v==null)return 0; const t=String(v).replace(/[^0-9.\-]/g,""); const n=parseFloat(t); return isNaN(n)?0:n;};
const parseMs=v=>{const t=Date.parse(v); return Number.isFinite(t)?t:0;};
const monthKey=iso=>{const d=new Date(iso); if(isNaN(d)) return "Unknown"; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;};
const niceMonth=k=>{if(k==="Unknown")return k; const [y,m]=k.split("-"); const d=new Date(+y,+m-1,1); return d.toLocaleString(undefined,{month:"short",year:"2-digit"});};

function timeout(ms){return new Promise((_,rej)=>setTimeout(()=>rej(new Error("Network timeout")),ms));}

(async function(){
  const status=document.getElementById('status');
  const content=document.getElementById('content');

  try{
    const urls=[
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}`,
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`,
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`
    ];
    let csv="";
    for(const u of urls){
      try{
        const res=await Promise.race([fetch(u,{mode:"cors",credentials:"omit",cache:"no-cache",referrerPolicy:"no-referrer"}),timeout(8000)]);
        if(res.ok){const t=await res.text(); if(t.trim()){csv=t; break;}}
      }catch(_){}
    }
    if(!csv.trim()) throw new Error("CSV not available");

    const parsed = Papa.parse(csv,{header:true});
    const rowsRaw = (parsed.data||[]).filter(r=>r && Object.values(r).some(x=>x && String(x).trim().length));
    const rows = rowsRaw.filter(r=>!isExcluded(r));
    if(!rows.length) throw new Error("No rows");

    const meaningful = rows.filter(r => parseMoney(r["Total"])>0 ||
      ["Date","Vendor","Category","Unit","Type","Status","Repair"].some(k=>r[k] && String(r[k]).trim().length)
    );
    if(!meaningful.length) throw new Error("No meaningful rows");

    const norm = s => String(s||"").trim().toLowerCase();
    const closedSet = new Set(["closed","completed","complete","done","resolved"]);
    const withStatus = meaningful.filter(r=>r["Status"] && String(r["Status"]).trim().length);
    const closedRows = withStatus.filter(r=>closedSet.has(norm(r["Status"])));
    const openRows   = withStatus.filter(r=>!closedSet.has(norm(r["Status"])));

    const totalSpend = meaningful.reduce((a,r)=>a+parseMoney(r["Total"]),0);

    const byMonth=new Map();
    meaningful.forEach(r=>{
      const k=monthKey(r["Date"]); if(k==="Unknown") return;
      const cur=byMonth.get(k)||{spend:0,count:0}; cur.spend+=parseMoney(r["Total"]); cur.count++; byMonth.set(k,cur);
    });
    const monthSeries=[...byMonth.entries()].sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([k,v])=>({label:niceMonth(k),spend:+v.spend.toFixed(2),jobs:v.count}));

    const byCat={}; meaningful.forEach(r=>{const c=r["Category"]||"Uncategorized"; byCat[c]=(byCat[c]||0)+parseMoney(r["Total"]);});
    const catSeries=Object.entries(byCat).map(([k,v])=>({label:k,value:+(+v).toFixed(2)})).sort((a,b)=>b.value-a.value);

    const byVendor={}; meaningful.forEach(r=>{const v=r["Vendor"]||"Unknown"; byVendor[v]=(byVendor[v]||0)+parseMoney(r["Total"]);});
    const vendorSeries=Object.entries(byVendor).map(([k,v])=>({label:k,value:+(+v).toFixed(2)})).sort((a,b)=>b.value-a.value).slice(0,6);

    const byUnit={}; meaningful.forEach(r=>{const u=r["Unit"]||"Unknown"; byUnit[u]=(byUnit[u]||0)+1;});
    const unitSeries=Object.entries(byUnit).map(([k,v])=>({label:k,value:v})).sort((a,b)=>b.value-a.value).slice(0,10);

    // KPI
    document.getElementById('kpi-spend').textContent = money(totalSpend);
    document.getElementById('kpi-closed').textContent = closedRows.length;
    document.getElementById('kpi-open').textContent = openRows.length;

    // Общие опции
    const common={
      responsive:true,maintainAspectRatio:false,resizeDelay:150,
      animation:{duration:600,easing:"easeOutCubic"},
      plugins:{legend:{labels:{color:"#E5E7EB"}},tooltip:{backgroundColor:"rgba(12,16,27,.95)",padding:12,titleColor:"#E5E7EB",bodyColor:"#E5E7EB",borderWidth:0}},
      scales:{x:{grid:{color:"rgba(255,255,255,.06)"},ticks:{color:"#D1D5DB",maxRotation:18,minRotation:18}},
              y:{beginAtZero:true,grid:{color:"rgba(255,255,255,.06)"},ticks:{color:"#D1D5DB"}}}
    };

    // Monthly
    new Chart(document.getElementById('chart-month'),{
      type:"line",
      data:{labels:monthSeries.map(x=>x.label),
        datasets:[
          {label:"Spend",data:monthSeries.map(x=>x.spend),borderColor:"#93C5FD",fill:true,
           backgroundColor:(ctx)=>{const a=ctx.chart.chartArea;if(!a) return "rgba(147,197,253,.15)";const g=ctx.chart.ctx.createLinearGradient(0,a.top,0,a.bottom);g.addColorStop(0,"rgba(96,165,250,.9)");g.addColorStop(1,"rgba(96,165,250,.05)");return g;},
           tension:.35,pointRadius:monthSeries.length<2?4:0,pointHoverRadius:5},
          {label:"Jobs",data:monthSeries.map(x=>x.jobs),borderColor:"#A7F3D0",tension:.35,pointRadius:monthSeries.length<2?4:0}
        ]},
      options:{...common,spanGaps:true}
    });

    // Spend by Category — красивое “выкручивание”
    const catChart = new Chart(document.getElementById('chart-cat'),{
      type:"doughnut",
      data:{labels:catSeries.map(x=>x.label),datasets:[{data:catSeries.map(x=>x.value),borderWidth:0,backgroundColor:catSeries.map((_,i)=>`hsl(${200+i*14} 80% 60%)`)}]},
      options:{
        ...common,scales:undefined,cutout:"62%",
        animation:{animateRotate:true,animateScale:true,duration:1400,easing:"easeInOutCubic",
          delay:(ctx)=>ctx.type==='data' ? ctx.dataIndex*60 : 0}
      }
    });

    // Vendors
    new Chart(document.getElementById('chart-vendor'),{
      type:"line",
      data:{labels:vendorSeries.map(x=>x.label),datasets:[{label:"Spend",data:vendorSeries.map(x=>x.value),borderColor:"#7DD3FC",tension:.35,pointRadius:3}]},
      options:common
    });

    // Units
    new Chart(document.getElementById('chart-unit'),{
      type:"bar",
      data:{labels:unitSeries.map(x=>x.label),datasets:[{label:"Breakdowns",data:unitSeries.map(x=>x.value),backgroundColor:"#93C5FD",borderRadius:10}]},
      options:common
    });

    // Таблицы
    const drawT=(id,list)=>{
      const el=document.getElementById(id);
      el.innerHTML=list.length? list.map(r=>`
        <tr class="hover:bg-white/5">
          <td class="pr-4 py-2">${r["Date"]||""}</td>
          <td class="pr-4 py-2">${r["Unit"]||""}</td>
          <td class="pr-4 py-2">${r["Category"]||""}</td>
          <td class="pr-4 py-2">${r["Repair"]||""}</td>
          <td class="pr-4 py-2">${r["Vendor"]||""}</td>
          <td class="pr-4 py-2">${money(parseMoney(r["Total"]))}</td>
          <td class="pr-4 py-2">${r["Status"]||""}</td>
        </tr>`).join('') : `<tr><td class="py-4 text-white/60" colspan="7">No data</td></tr>`;
    };
    const sortDesc=(a,b)=>parseMs(b["Date"])-parseMs(a["Date"]);
    drawT("open-body",  withStatus.filter(r=>!closedSet.has(norm(r["Status"]))).sort(sortDesc));
    drawT("closed-body",withStatus.filter(r=> closedSet.has(norm(r["Status"]))).sort(sortDesc));

    status.classList.add("hidden");
    content.classList.remove("hidden");
  }catch(err){
    console.error(err);
    const s=document.getElementById('status');
    s.textContent="Error: "+(err?.message||String(err));
    s.classList.remove("text-white/70"); s.classList.add("text-red-300");
  }
})();
</script>
</body>
</html>
