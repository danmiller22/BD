<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>US Team Fleet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{margin:0;background:#0B0F1A;color:#fff;overflow-x:hidden}
    .glass{background:rgba(255,255,255,.06);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.18);border-radius:16px;box-shadow:inset 0 1px 0 rgba(255,255,255,.2)}
    .card{padding:24px}
    .title{font-weight:600}
    .fade{opacity:0;transform:translateY(10px);animation:fade .6s cubic-bezier(.22,1,.36,1) forwards}
    @keyframes fade{to{opacity:1;transform:none}}
    .kpi{font-size:1.875rem;line-height:2.25rem}
    .sub{color:#cbd5e1}
    .shadow-soft{box-shadow:0 15px 40px rgba(0,0,0,.35)}
    .chart-wrap{position:relative;height:280px;overflow:hidden;border-radius:12px}
    @media (min-width:1024px){ .chart-wrap{height:300px} }
    canvas{display:block;width:100%!important;height:100%!important}
  </style>
</head>
<body>
  <div class="w-full max-w-[1400px] mx-auto px-6 md:px-10 py-8 md:py-12">
    <header class="mb-8 md:mb-12 fade">
      <h1 class="text-2xl md:text-4xl title">US Team Fleet</h1>
    </header>

    <div id="status" class="text-white/70 fade">Loading data…</div>

    <div id="content" class="space-y-8 hidden">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="glass card fade shadow-soft">
          <div class="text-sm text-white/70">Total Spend</div>
          <div id="kpi-spend" class="kpi mt-1">—</div>
          <div class="text-xs sub mt-1">Sum of all jobs</div>
        </div>
        <div class="glass card fade shadow-soft">
          <div class="text-sm text-white/70">Jobs Closed</div>
          <div id="kpi-closed" class="kpi mt-1">—</div>
          <div class="text-xs sub mt-1">Completed work orders</div>
        </div>
        <div class="glass card fade shadow-soft">
          <div class="text-sm text-white/70">Jobs Open</div>
          <div id="kpi-open" class="kpi mt-1">—</div>
          <div class="text-xs sub mt-1">Active or pending</div>
        </div>
      </div>

      <div class="glass card fade shadow-soft">
        <div class="mb-4 text-lg">Monthly Spend</div>
        <div class="chart-wrap"><canvas id="chart-month"></canvas></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="glass card fade shadow-soft">
          <div class="mb-4 text-lg">Spend by Category</div>
          <div class="chart-wrap"><canvas id="chart-cat"></canvas></div>
        </div>
        <div class="glass card fade lg:col-span-2 shadow-soft">
          <div class="mb-4 text-lg">Top Vendors</div>
          <div class="chart-wrap"><canvas id="chart-vendor"></canvas></div>
        </div>
      </div>

      <div class="glass card fade shadow-soft">
        <div class="mb-4 text-lg">Most Frequent Units (Breakdowns)</div>
        <div class="chart-wrap"><canvas id="chart-unit"></canvas></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass card fade shadow-soft">
          <div class="mb-4 text-lg">Open Reports</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-white/70">
                <tr>
                  <th class="text-left pr-4 py-2">Date</th>
                  <th class="text-left pr-4 py-2">Unit</th>
                  <th class="text-left pr-4 py-2">Category</th>
                  <th class="text-left pr-4 py-2">Repair</th>
                  <th class="text-left pr-4 py-2">Vendor</th>
                  <th class="text-left pr-4 py-2">Total</th>
                  <th class="text-left pr-4 py-2">Status</th>
                </tr>
              </thead>
              <tbody id="open-body" class="divide-y divide-white/10"></tbody>
            </table>
          </div>
        </div>

        <div class="glass card fade shadow-soft">
          <div class="mb-4 text-lg">Closed Reports</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="text-white/70">
                <tr>
                  <th class="text-left pr-4 py-2">Date</th>
                  <th class="text-left pr-4 py-2">Unit</th>
                  <th class="text-left pr-4 py-2">Category</th>
                  <th class="text-left pr-4 py-2">Repair</th>
                  <th class="text-left pr-4 py-2">Vendor</th>
                  <th class="text-left pr-4 py-2">Total</th>
                  <th class="text-left pr-4 py-2">Status</th>
                </tr>
              </thead>
              <tbody id="closed-body" class="divide-y divide-white/10"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const SHEET_ID = "1QiFjfGky5vNBPf9WCPNkvszjJXH9413GecYzioSO32Q";
const SHEET_GID = "1435752205";

const money = n => new Intl.NumberFormat(undefined,{style:"currency",currency:"USD"}).format(n||0);
const parseMoney = v => { if(v==null) return 0; const t=String(v).replace(/[^0-9.\\-]/g,""); const n=parseFloat(t); return isNaN(n)?0:n; };
const parseMs = v => { const t=Date.parse(v); return Number.isFinite(t)?t:0; };
const monthKey = iso => { const d=new Date(iso); if(isNaN(d)) return "Unknown"; return \`\${d.getFullYear()}-\${String(d.getMonth()+1).padStart(2,"0")}\`; };
const niceMonth = key => { if(key==="Unknown") return key; const [y,m]=key.split("-"); const d=new Date(+y,+m-1,1); return d.toLocaleString(undefined,{month:"short",year:"2-digit"}); };

(async function main(){
  const status = document.getElementById('status');
  const content = document.getElementById('content');

  try{
    const urls = [
      \`https://docs.google.com/spreadsheets/d/\${SHEET_ID}/gviz/tq?tqx=out:csv&gid=\${SHEET_GID}\`,
      \`https://docs.google.com/spreadsheets/d/\${SHEET_ID}/pub?gid=\${SHEET_GID}&single=true&output=csv\`,
      \`https://docs.google.com/spreadsheets/d/\${SHEET_ID}/export?format=csv&gid=\${SHEET_GID}\`
    ];
    let csv = "";
    for(const u of urls){
      const r = await fetch(u,{mode:"cors",credentials:"omit",cache:"no-cache"});
      if(r.ok){ csv = await r.text(); if(csv.trim()) break; }
    }
    if(!csv.trim()) throw new Error("CSV empty");

    const parsed = Papa.parse(csv,{header:true});
    const rows = (parsed.data||[]).filter(r=>r && Object.values(r).some(x=>x && String(x).trim().length));
    if(!rows.length) throw new Error("No rows");

    const meaningful = rows.filter(r => parseMoney(r["Total"])>0 ||
      ["Date","Vendor","Category","Unit","Type"].some(k=>r[k] && String(r[k]).trim().length)
    );
    if(!meaningful.length) throw new Error("No meaningful rows");

    const norm = s => String(s||"").trim().toLowerCase();
    const closedSet = new Set(["closed","completed","complete","done","resolved"]);
    const withStatus = meaningful.filter(r=>r["Status"] && String(r["Status"]).trim().length);
    const closedRows = withStatus.filter(r=>closedSet.has(norm(r["Status"])));
    const openRows   = withStatus.filter(r=>!closedSet.has(norm(r["Status"])));

    const totalSpend = meaningful.reduce((a,r)=>a+parseMoney(r["Total"]),0);

    const byMonth = new Map();
    meaningful.forEach(r=>{
      const k = monthKey(r["Date"]);
      if(k==="Unknown") return;
      const cur = byMonth.get(k)||{spend:0,count:0};
      cur.spend += parseMoney(r["Total"]);
      cur.count++;
      byMonth.set(k,cur);
    });
    const monthSeries = [...byMonth.entries()]
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([k,v])=>({label:niceMonth(k), spend:+v.spend.toFixed(2), jobs:v.count}));

    const byCat = {};
    meaningful.forEach(r=>{ const c=r["Category"]||"Uncategorized"; byCat[c]=(byCat[c]||0)+parseMoney(r["Total"]); });
    const catSeries = Object.entries(byCat).map(([k,v])=>({label:k, value:+(+v).toFixed(2)})).sort((a,b)=>b.value-a.value);

    const byVendor = {};
    meaningful.forEach(r=>{ const v=r["Vendor"]||"Unknown"; byVendor[v]=(byVendor[v]||0)+parseMoney(r["Total"]); });
    const vendorSeries = Object.entries(byVendor).map(([k,v])=>({label:k, value:+(+v).toFixed(2)})).sort((a,b)=>b.value-a.value).slice(0,6);

    const byUnit = {};
    meaningful.forEach(r=>{ const u=r["Unit"]||"Unknown"; byUnit[u]=(byUnit[u]||0)+1; });
    const unitSeries = Object.entries(byUnit).map(([k,v])=>({label:k, value:v})).sort((a,b)=>b.value-a.value).slice(0,10);

    document.getElementById('kpi-spend').textContent = money(totalSpend);
    document.getElementById('kpi-closed').textContent = closedRows.length;
    document.getElementById('kpi-open').textContent = openRows.length;

    const common = {
      responsive: true,
      maintainAspectRatio: false,
      resizeDelay: 150,
      animation: { duration: 600, easing: "easeOutCubic" },
      plugins: {
        legend: { labels: { color: "#E5E7EB" } },
        tooltip: { backgroundColor: "rgba(12,16,27,0.95)", padding: 12, titleColor:"#E5E7EB", bodyColor:"#E5E7EB", borderWidth:0 }
      },
      scales: {
        x: { grid: { color:"rgba(255,255,255,0.06)" }, ticks: { color:"#D1D5DB", maxRotation:20, minRotation:20 } },
        y: { beginAtZero:true, grid: { color:"rgba(255,255,255,0.06)" }, ticks: { color:"#D1D5DB" } }
      }
    };

    const monthCtx = document.getElementById('chart-month');
    const chartMonth = new Chart(monthCtx, {
      type: "line",
      data: {
        labels: monthSeries.map(x=>x.label),
        datasets: [
          {
            label:"Spend",
            data: monthSeries.map(x=>x.spend),
            borderColor:"#93C5FD",
            fill:true,
            backgroundColor:(ctx)=> {
              const {chart:{ctx:c,chartArea}}=ctx;
              if(!chartArea) return "rgba(147,197,253,0.15)";
              const g=c.createLinearGradient(0,chartArea.top,0,chartArea.bottom);
              g.addColorStop(0,"rgba(96,165,250,0.9)");
              g.addColorStop(1,"rgba(96,165,250,0.05)");
              return g;
            },
            tension:0.35,
            pointRadius: monthSeries.length<2 ? 4 : 0,
            pointHoverRadius:5
          },
          {
            label:"Jobs",
            data: monthSeries.map(x=>x.jobs),
            borderColor:"#A7F3D0",
            tension:0.35,
            pointRadius: monthSeries.length<2 ? 4 : 0
          }
        ]
      },
      options: { ...common, spanGaps:true }
    });

    const chartCat = new Chart(document.getElementById('chart-cat'), {
      type: "doughnut",
      data: {
        labels: catSeries.map(x=>x.label),
        datasets: [{ data: catSeries.map(x=>x.value), borderWidth:0, backgroundColor: catSeries.map((_,i)=>`hsl(${200+i*14} 80% 60%)`) }]
      },
      options: { ...common, scales: undefined, cutout: "62%" }
    });

    const chartVendor = new Chart(document.getElementById('chart-vendor'), {
      type: "line",
      data: { labels: vendorSeries.map(x=>x.label), datasets: [{ label:"Spend", data: vendorSeries.map(x=>x.value), borderColor:"#7DD3FC", tension:0.35, pointRadius:3 }] },
      options: common
    });

    const chartUnit = new Chart(document.getElementById('chart-unit'), {
      type: "bar",
      data: { labels: unitSeries.map(x=>x.label), datasets: [{ label:"Breakdowns", data: unitSeries.map(x=>x.value), backgroundColor:"#93C5FD", borderRadius:10 }] },
      options: common
    });

    window.addEventListener('resize', ()=> {
      chartMonth.resize(); chartCat.resize(); chartVendor.resize(); chartUnit.resize();
    });

    const tb = (id,list)=>{
      const el=document.getElementById(id);
      el.innerHTML=list.length? list.map(r=>`
        <tr class="hover:bg-white/5">
          <td class="pr-4 py-2">${r["Date"]||""}</td>
          <td class="pr-4 py-2">${r["Unit"]||""}</td>
          <td class="pr-4 py-2">${r["Category"]||""}</td>
          <td class="pr-4 py-2">${r["Repair"]||""}</td>
          <td class="pr-4 py-2">${r["Vendor"]||""}</td>
          <td class="pr-4 py-2">${money(parseMoney(r["Total"]))}</td>
          <td class="pr-4 py-2">${r["Status"]||""}</td>
        </tr>`).join('') : `<tr><td class="py-4 text-white/60" colspan="7">No data</td></tr>`;
    };
    const sortDesc=(a,b)=>parseMs(b["Date"])-parseMs(a["Date"]);
    tb("open-body",  withStatus.filter(r=>!closedSet.has(norm(r["Status"]))).sort(sortDesc));
    tb("closed-body",withStatus.filter(r=> closedSet.has(norm(r["Status"]))).sort(sortDesc));

    status.classList.add("hidden");
    content.classList.remove("hidden");
  }catch(err){
    status.textContent = "Error: " + (err && err.message ? err.message : String(err));
    status.classList.remove("text-white/70");
    status.classList.add("text-red-300");
  }
})();
</script>
</body>
</html>
