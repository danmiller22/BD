<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>US Team Fleet</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#0B0F1A; --fg:#e5e7eb; --muted:#cbd5e1; --glass:rgba(255,255,255,.06);
    --border:rgba(255,255,255,.18); --grid:rgba(255,255,255,.06);
    --card-pad:24px; --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);overflow-x:hidden}
  .screen{min-height:100vh;width:100%;padding:32px}
  .container-max{max-width:1400px;margin:0 auto}
  .glass{background:var(--glass);backdrop-filter:blur(18px);border:1px solid var(--border);border-radius:var(--radius);box-shadow:inset 0 1px 0 rgba(255,255,255,.22), 0 20px 60px rgba(0,0,0,.35)}
  .card{padding:var(--card-pad)}
  .title{font-weight:700;letter-spacing:.2px}
  .kpi{font-size:1.9rem;line-height:2.2rem}
  .sub{color:var(--muted)}
  .chart-wrap{position:relative;height:310px;overflow:hidden;border-radius:12px}
  @media (min-height:900px){ .chart-wrap{height:360px} }
  canvas{display:block;width:100%!important;height:100%!important}

  /* Плавные появления без blur */
  .reveal{opacity:0;transform:translateY(14px) scale(.98)}
  .reveal.show{animation:reveal .7s cubic-bezier(.22,1,.36,1) forwards}
  @keyframes reveal{to{opacity:1;transform:none}}

  /* Шиммер для загрузки */
  .skeleton{position:relative;overflow:hidden}
  .skeleton::after{
    content:"";position:absolute;inset:0;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent);
    transform:translateX(-100%);animation:shimmer 1.3s infinite;
  }
  @keyframes shimmer{to{transform:translateX(100%)}}

  /* Вход пончика */
  .spin-in{transform:rotate(-140deg) scale(.6);opacity:.0}
  .spin-in.ready{animation:spinIn 1.2s cubic-bezier(.22,1,.36,1) forwards}
  @keyframes spinIn{to{transform:none;opacity:1}}

  @media (prefers-reduced-motion:reduce){
    .reveal,.spin-in{animation:none !important;opacity:1;transform:none}
    .skeleton::after{display:none}
  }
</style>
</head>
<body>
  <div class="screen">
    <div class="container-max">
      <header class="mb-8 reveal" style="animation-delay:60ms">
        <h1 class="text-2xl md:text-4xl title">US Team Fleet</h1>
      </header>

      <div id="status" class="text-white/70 reveal" style="animation-delay:120ms">Loading data…</div>

      <div id="content" class="space-y-8 hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="glass card reveal skeleton" style="animation-delay:120ms">
            <div class="text-sm text-white/70">Total Spend</div>
            <div id="kpi-spend" class="kpi mt-1">—</div>
            <div class="text-xs sub mt-1">Sum of all jobs</div>
          </div>
          <div class="glass card reveal skeleton" style="animation-delay:180ms">
            <div class="text-sm text-white/70">Jobs Closed</div>
            <div id="kpi-closed" class="kpi mt-1">—</div>
            <div class="text-xs sub mt-1">Completed work orders</div>
          </div>
          <div class="glass card reveal skeleton" style="animation-delay:240ms">
            <div class="text-sm text-white/70">Jobs Open</div>
            <div id="kpi-open" class="kpi mt-1">—</div>
            <div class="text-xs sub mt-1">Active or pending</div>
          </div>
        </div>

        <div class="glass card reveal" style="animation-delay:300ms">
          <div class="mb-4 text-lg">Monthly Spend</div>
          <div class="chart-wrap"><canvas id="chart-month"></canvas></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="glass card reveal" style="animation-delay:360ms">
            <div class="mb-4 text-lg">Spend by Category</div>
            <div class="chart-wrap spin-in" id="cat-spin"><canvas id="chart-cat"></canvas></div>
          </div>
          <div class="glass card reveal lg:col-span-2" style="animation-delay:420ms">
            <div class="mb-4 text-lg">Top Vendors</div>
            <div class="chart-wrap"><canvas id="chart-vendor"></canvas></div>
          </div>
        </div>

        <div class="glass card reveal" style="animation-delay:480ms">
          <div class="mb-4 text-lg">Most Frequent Units (Breakdowns)</div>
          <div class="chart-wrap"><canvas id="chart-unit"></canvas></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass card reveal" style="animation-delay:540ms">
            <div class="mb-4 text-lg">Open Reports</div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-white/70">
                  <tr>
                    <th class="text-left pr-4 py-2">Date</th><th class="text-left pr-4 py-2">Unit</th>
                    <th class="text-left pr-4 py-2">Category</th><th class="text-left pr-4 py-2">Repair</th>
                    <th class="text-left pr-4 py-2">Vendor</th><th class="text-left pr-4 py-2">Total</th>
                    <th class="text-left pr-4 py-2">Status</th>
                  </tr>
                </thead>
                <tbody id="open-body" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>

          <div class="glass card reveal" style="animation-delay:600ms">
            <div class="mb-4 text-lg">Closed Reports</div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-white/70">
                  <tr>
                    <th class="text-left pr-4 py-2">Date</th><th class="text-left pr-4 py-2">Unit</th>
                    <th class="text-left pr-4 py-2">Category</th><th class="text-left pr-4 py-2">Repair</th>
                    <th class="text-left pr-4 py-2">Vendor</th><th class="text-left pr-4 py-2">Total</th>
                    <th class="text-left pr-4 py-2">Status</th>
                  </tr>
                </thead>
                <tbody id="closed-body" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const SHEET_ID="1QiFjfGky5vNBPf9WCPNkvszjJXH9413GecYzioSO32Q";
const SHEET_GID="1435752205";

const money=n=>new Intl.NumberFormat(undefined,{style:"currency",currency:"USD"}).format(n||0);
const parseMoney=v=>{if(v==null)return 0; const t=String(v).replace(/[^0-9.\-]/g,""); const n=parseFloat(t); return isNaN(n)?0:n;};
const parseMs=v=>{const t=Date.parse(v); return Number.isFinite(t)?t:0;};
const monthKey=iso=>{const d=new Date(iso); if(isNaN(d)) return "Unknown"; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;};
const niceMonth=k=>{if(k==="Unknown")return k; const [y,m]=k.split("-"); const d=new Date(+y,+m-1,1); return d.toLocaleString(undefined,{month:"short",year:"2-digit"});};
const reduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

/* Глобально показать все элементы .reveal (без IO, чтобы не залипало) */
function revealAll(){ document.querySelectorAll('.reveal').forEach(el=>el.classList.add('show')); }
document.addEventListener('DOMContentLoaded', revealAll);

/* Chart.js glow */
const GlowShadow = {
  id:'glowShadow',
  beforeDatasetsDraw(chart){ const {ctx, chartArea} = chart; if(!chartArea) return; ctx.save(); ctx.shadowColor='rgba(125,211,252,.35)'; ctx.shadowBlur=14; },
  afterDatasetsDraw(chart){ chart.ctx.restore(); }
};
Chart.register(GlowShadow);
Chart.defaults.elements.line.tension = 0.35;
Chart.defaults.elements.line.borderCapStyle = 'round';
Chart.defaults.elements.point.radius = 0;

function areaGradient(ctx, topColor, bottomColor){
  const {chart:{ctx:c, chartArea:a}} = ctx;
  if(!a) return bottomColor;
  const g=c.createLinearGradient(0,a.top,0,a.bottom);
  g.addColorStop(0, topColor); g.addColorStop(1, bottomColor);
  return g;
}

function timeout(ms){return new Promise((_,rej)=>setTimeout(()=>rej(new Error("Network timeout")),ms));}
async function fetchCSV(){
  const bust = Date.now().toString(36);
  const urls=[
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}&_=${bust}`,
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv&_=${bust}`,
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}&_=${bust}`
  ];
  for(const u of urls){
    try{
      const res=await Promise.race([fetch(u,{mode:"cors",credentials:"omit",cache:"no-cache",referrerPolicy:"no-referrer"}),timeout(8000)]);
      if(res.ok){ const t=await res.text(); if(t.trim()) return t; }
    }catch(_){}
  }
  throw new Error("CSV not available");
}

(async function main(){
  const status=document.getElementById('status');
  const content=document.getElementById('content');

  try{
    const csv = await fetchCSV();
    const parsed = Papa.parse(csv,{header:true});
    const rows = (parsed.data||[]).filter(r=>r && Object.values(r).some(x=>x && String(x).trim().length));
    if(!rows.length) throw new Error("No rows");

    const meaningful = rows.filter(r => parseMoney(r["Total"])>0 ||
      ["Date","Vendor","Category","Unit","Type","Status","Repair"].some(k=>r[k] && String(r[k]).trim().length)
    );
    if(!meaningful.length) throw new Error("No meaningful rows");

    const norm=s=>String(s||"").trim().toLowerCase();
    const closedSet=new Set(["closed","completed","complete","done","resolved"]);
    const withStatus=meaningful.filter(r=>r["Status"] && String(r["Status"]).trim().length);
    const closedRows=withStatus.filter(r=>closedSet.has(norm(r["Status"])));
    const openRows  =withStatus.filter(r=>!closedSet.has(norm(r["Status"])));

    const totalSpend = meaningful.reduce((a,r)=>a+parseMoney(r["Total"]),0);

    const byMonth=new Map();
    meaningful.forEach(r=>{
      const k=monthKey(r["Date"]); if(k==="Unknown") return;
      const cur=byMonth.get(k)||{spend:0,count:0};
      cur.spend+=parseMoney(r["Total"]); cur.count++; byMonth.set(k,cur);
    });
    const monthSeries=[...byMonth.entries()].sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([k,v])=>({label:niceMonth(k),spend:+v.spend.toFixed(2),jobs:v.count}));

    const byCat={}; meaningful.forEach(r=>{const c=r["Category"]||"Uncategorized"; byCat[c]=(byCat[c]||0)+parseMoney(r["Total"]);});
    const catSeries=Object.entries(byCat).map(([k,v])=>({label:k,value:+(+v).toFixed(2)})).sort((a,b)=>b.value-a.value);

    const byVendor={}; meaningful.forEach(r=>{const v=r["Vendor"]||"Unknown"; byVendor[v]=(byVendor[v]||0)+parseMoney(r["Total"]);});
    const vendorSeries=Object.entries(byVendor).map(([k,v])=>({label:k,value:+(+v).toFixed(2)})).sort((a,b)=>b.value-a.value).slice(0,8);

    const byUnit={}; meaningful.forEach(r=>{const u=r["Unit"]||"Unknown"; byUnit[u]=(byUnit[u]||0)+1;});
    const unitSeries=Object.entries(byUnit).map(([k,v])=>({label:k,value:v})).sort((a,b)=>b.value-a.value).slice(0,12);

    /* KPI */
    const kSpend=document.getElementById('kpi-spend');
    const kClosed=document.getElementById('kpi-closed');
    const kOpen=document.getElementById('kpi-open');
    document.querySelectorAll('.skeleton').forEach(el=>el.classList.remove('skeleton'));

    function animateCounter(el, to, dur=800){
      if(reduced){ el.textContent = (el===kSpend? money(to): to); return; }
      const start=performance.now();
      function tick(t){
        const p=Math.min(1,(t-start)/dur);
        const e=1-Math.pow(1-p,3);
        const v=to*e;
        el.textContent = el===kSpend ? money(v) : Math.round(v);
        if(p<1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }
    animateCounter(kSpend,totalSpend);
    animateCounter(kClosed,closedRows.length);
    animateCounter(kOpen,openRows.length);

    /* Общие опции */
    const baseAnim = reduced ? 0 : 700;
    const common={
      responsive:true,maintainAspectRatio:false,resizeDelay:150,
      animation:{duration:baseAnim,easing:"easeOutCubic"},
      plugins:{legend:{labels:{color:"#E5E7EB"}},tooltip:{backgroundColor:"rgba(12,16,27,.95)",padding:12,titleColor:"#E5E7EB",bodyColor:"#E5E7EB",borderWidth:0}},
      scales:{x:{grid:{color:"var(--grid)"},ticks:{color:"#D1D5DB",maxRotation:18,minRotation:18}},
              y:{beginAtZero:true,grid:{color:"var(--grid)"},ticks:{color:"#D1D5DB"}}}
    };

    /* Monthly */
    new Chart(document.getElementById('chart-month'),{
      type:"line",
      data:{
        labels:monthSeries.map(x=>x.label),
        datasets:[
          {label:"Spend",data:monthSeries.map(x=>x.spend),borderColor:"#93C5FD",fill:true,
           backgroundColor:(ctx)=>areaGradient(ctx,"rgba(96,165,250,.9)","rgba(96,165,250,.05)"),
           pointRadius:monthSeries.length<2?4:0,pointHoverRadius:5},
          {label:"Jobs",data:monthSeries.map(x=>x.jobs),borderColor:"#A7F3D0",
           pointRadius:monthSeries.length<2?4:0}
        ]},
      options:{...common,spanGaps:true}
    });

    /* Spend by Category — «выкручивание» + масштаб */
    new Chart(document.getElementById('chart-cat'),{
      type:"doughnut",
      data:{labels:catSeries.map(x=>x.label),
            datasets:[{data:catSeries.map(x=>x.value),borderWidth:0,
                       backgroundColor:catSeries.map((_,i)=>`hsl(${200+i*14} 80% 60%)`)}]},
      options:{...common,scales:undefined,cutout:"62%",
        animation:{animateRotate:!reduced,animateScale:!reduced,duration:1200,easing:"easeInOutCubic",
          delay:(ctx)=>ctx.type==='data'? ctx.dataIndex*60 : 0}}
    });
    const catSpin=document.getElementById('cat-spin'); requestAnimationFrame(()=>catSpin.classList.add('ready'));

    /* Vendors */
    new Chart(document.getElementById('chart-vendor'),{
      type:"line",
      data:{labels:vendorSeries.map(x=>x.label),
            datasets:[{label:"Spend",data:vendorSeries.map(x=>x.value),borderColor:"#7DD3FC",pointRadius:3}]},
      options:common
    });

    /* Units */
    new Chart(document.getElementById('chart-unit'),{
      type:"bar",
      data:{labels:unitSeries.map(x=>x.label),
            datasets:[{label:"Breakdowns",data:unitSeries.map(x=>x.value),backgroundColor:"#93C5FD",borderRadius:10}]},
      options:common
    });

    /* Таблицы */
    const drawT=(id,list)=>{
      const el=document.getElementById(id);
      el.innerHTML=list.length? list.map(r=>`
        <tr class="hover:bg-white/5 transition-colors">
          <td class="pr-4 py-2">${r["Date"]||""}</td>
          <td class="pr-4 py-2">${r["Unit"]||""}</td>
          <td class="pr-4 py-2">${r["Category"]||""}</td>
          <td class="pr-4 py-2">${r["Repair"]||""}</td>
          <td class="pr-4 py-2">${r["Vendor"]||""}</td>
          <td class="pr-4 py-2">${money(parseMoney(r["Total"]))}</td>
          <td class="pr-4 py-2">${r["Status"]||""}</td>
        </tr>`).join('') : `<tr><td class="py-4 text-white/60" colspan="7">No data</td></tr>`;
    };
    const sortDesc=(a,b)=>parseMs(b["Date"])-parseMs(a["Date"]);
    drawT("open-body",  withStatus.filter(r=>!closedSet.has(norm(r["Status"]))).sort(sortDesc));
    drawT("closed-body",withStatus.filter(r=> closedSet.has(norm(r["Status"]))).sort(sortDesc));

    status.classList.add("hidden");
    content.classList.remove("hidden");
    revealAll(); // гарантированно снимаем стартовое состояние

  }catch(err){
    console.error(err);
    const s=document.getElementById('status');
    s.textContent="Error: "+(err?.message||String(err));
    s.classList.remove("text-white/70"); s.classList.add("text-red-300");
  }
})();
</script>
</body>
</html>
