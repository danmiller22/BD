<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>US Team Fleet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%} body{background:#0B0F1A;color:#fff}
    .glass{background:rgba(255,255,255,0.06);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,0.18);border-radius:16px;box-shadow:inset 0 1px 0 rgba(255,255,255,.2)}
    .card-pad{padding:24px} .title{font-weight:600}
    .fadein{opacity:0;transform:translateY(10px);animation:fade 600ms cubic-bezier(.22,1,.36,1) forwards}
    @keyframes fade{to{opacity:1;transform:none}} .chart h2{margin-bottom:12px}
    svg,.recharts-wrapper,.recharts-surface{background:transparent!important}
    .recharts-tooltip-wrapper{filter:drop-shadow(0 6px 18px rgba(0,0,0,.35))}
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
</head>
<body>
  <div id="app" class="min-h-screen relative"></div>

  <script>
    (function waitForLibs() {
      if (!(window.React && window.ReactDOM && window.Recharts && window.Papa)) {
        setTimeout(waitForLibs, 50);
        return;
      }

      const h = React.createElement;
      const { useEffect, useMemo, useState } = React;
      const {
        ResponsiveContainer, AreaChart, Area, XAxis, YAxis, Tooltip,
        PieChart, Pie, Cell, Legend, LineChart, Line, BarChart, Bar
      } = Recharts;

      const SHEET_ID = "1QiFjfGky5vNBPf9WCPNkvszjJXH9413GecYzioSO32Q";
      const SHEET_GID = "1435752205";

      const money = n => new Intl.NumberFormat(undefined,{style:"currency",currency:"USD"}).format(n||0);
      const parseMoney = v => { if(v==null) return 0; const t=String(v).replace(/[^0-9.\-]/g,""); const n=parseFloat(t); return isNaN(n)?0:n; };
      const niceMonth = k => { if(k==="Unknown") return k; const [y,m]=k.split("-"); const d=new Date(+y,+m-1,1); return d.toLocaleString(undefined,{month:"short",year:"2-digit"}); };
      const parseMs = v => { const t=Date.parse(v); return Number.isFinite(t)?t:0; };

      function App() {
        const [rows,setRows] = useState([]);
        const [loading,setLoading] = useState(true);
        const [error,setError] = useState(null);

        useEffect(() => {
          let cancelled = false;
          async function load() {
            const urls = [
              `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}`,
              `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=csv`,
              `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`
            ];
            let last = null;
            for (const u of urls) {
              try {
                const r = await fetch(u,{mode:"cors",credentials:"omit",cache:"no-cache",headers:{Accept:"text/csv"}});
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const t = await r.text();
                if (!t.trim()) throw new Error("Empty CSV");
                const p = Papa.parse(t,{header:true});
                const clean = (p.data||[]).filter(z => z && Object.values(z).some(x => x && String(x).trim().length));
                if (!cancelled) { setRows(clean); setError(null); setLoading(false); }
                return;
              } catch(e) { last = e; }
            }
            if (!cancelled) { setRows([]); setError(last && last.message ? last.message : "Failed to fetch CSV"); setLoading(false); }
          }
          load();
          return () => { cancelled = true; };
        }, []);

        const metrics = useMemo(() => {
          if (!rows.length) return null;
          const meaningful = rows.filter(r =>
            parseMoney(r["Total"])>0 ||
            ["Date","Vendor","Category","Unit","Type"].some(k => r[k] && String(r[k]).trim().length)
          );
          if (!meaningful.length) return null;

          const norm = s => String(s||"").trim().toLowerCase();
          const closedSet = new Set(["closed","completed","complete","done","resolved"]);
          const withStatus = meaningful.filter(r => r["Status"] && String(r["Status"]).trim().length);
          const closedRows = withStatus.filter(r => closedSet.has(norm(r["Status"])));
          const openRows   = withStatus.filter(r => !closedSet.has(norm(r["Status"])));

          const totalSpend = meaningful.reduce((a,r)=>a+parseMoney(r["Total"]),0);

          const byMonth = new Map();
          meaningful.forEach(r => {
            const d = new Date(r["Date"]); if (isNaN(d)) return;
            const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
            const cur = byMonth.get(k) || {k,spend:0,count:0};
            cur.spend += parseMoney(r["Total"]); cur.count++; byMonth.set(k,cur);
          });
          const monthSeries = Array.from(byMonth.values())
            .sort((a,b)=>a.k.localeCompare(b.k))
            .map(m => ({name: niceMonth(m.k), Spend: +m.spend.toFixed(2), Jobs: m.count}));

          const byCat = {};
          meaningful.forEach(r => { const c=r["Category"]||"Uncategorized"; byCat[c]=(byCat[c]||0)+parseMoney(r["Total"]); });
          const categorySeries = Object.entries(byCat)
            .map(([name,v])=>({name,value:+(+v).toFixed(2)}))
            .sort((a,b)=>b.value-a.value);

          const byVendor = {};
          meaningful.forEach(r => { const v=r["Vendor"]||"Unknown"; byVendor[v]=(byVendor[v]||0)+parseMoney(r["Total"]); });
          const vendorSeries = Object.entries(byVendor)
            .map(([name,v])=>({name,value:+(+v).toFixed(2)}))
            .sort((a,b)=>b.value-a.value).slice(0,6);

          const byUnit = {};
          meaningful.forEach(r => { const u=r["Unit"]||"Unknown"; byUnit[u]=(byUnit[u]||0)+1; });
          const unitSeries = Object.entries(byUnit)
            .map(([name,v])=>({name,value:v}))
            .sort((a,b)=>b.value-a.value).slice(0,10);

          const sortDesc = (a,b)=> parseMs(b["Date"]) - parseMs(a["Date"]);
          return { totalSpend, open: openRows.length, closed: closedRows.length,
                   monthSeries, categorySeries, vendorSeries, unitSeries,
                   openRows: openRows.sort(sortDesc), closedRows: closedRows.sort(sortDesc) };
        }, [rows]);

        return h("div",{className:"w-full px-6 md:px-10 py-8 md:py-12"},
          h("header",{className:"mb-8 md:mb-12 fadein"},
            h("h1",{className:"text-2xl md:text-4xl title"},"US Team Fleet")
          ),
          loading && h("div",{className:"text-white/70"},"Loading dataâ€¦"),
          (!loading && !rows.length) && h("div",{className:"text-red-300"}, error || "No data"),
          (!loading && metrics) && h("div",{className:"space-y-8"},

            h("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6"},
              h("div",{className:"glass card-pad fadein"},
                h("div",{className:"text-sm text-white/70"},"Total Spend"),
                h("div",{className:"text-3xl md:text-4xl mt-1"}, money(metrics.totalSpend)),
                h("div",{className:"text-xs text-white/60 mt-1"},"Sum of all jobs")
              ),
              h("div",{className:"glass card-pad fadein"},
                h("div",{className:"text-sm text-white/70"},"Jobs Closed"),
                h("div",{className:"text-3xl md:text-4xl mt-1"}, String(metrics.closed)),
                h("div",{className:"text-xs text-white/60 mt-1"},"Completed work orders")
              ),
              h("div",{className:"glass card-pad fadein"},
                h("div",{className:"text-sm text-white/70"},"Jobs Open"),
                h("div",{className:"text-3xl md:text-4xl mt-1"}, String(metrics.open)),
                h("div",{className:"text-xs text-white/60 mt-1"},"Active or pending")
              )
            ),

            h("div",{className:"glass card-pad fadein chart"},
              h("h2",{className:"text-lg"},"Monthly Spend"),
              h("div",{className:"h-64"},
                h(ResponsiveContainer,{width:"100%",height:"100%"},
                  h(AreaChart,{data:metrics.monthSeries,margin:{top:0,right:0,left:0,bottom:0}},
                    h("defs",null,
                      h("linearGradient",{id:"grad",x1:"0",y1:"0",x2:"0",y2:"1"},
                        h("stop",{offset:"0%",stopColor:"#60A5FA",stopOpacity:0.9}),
                        h("stop",{offset:"100%",stopColor:"#60A5FA",stopOpacity:0.05})
                      )
                    ),
                    h(XAxis,{dataKey:"name",tick:{fill:"#D1D5DB"},axisLine:false,tickLine:false}),
                    h(YAxis,{tick:{fill:"#D1D5DB"},axisLine:false,tickLine:false,width:72}),
                    h(Tooltip,{contentStyle:{background:"rgba(12,16,27,0.9)",border:"none",borderRadius:12,color:"#E5E7EB"}}),
                    h(Area,{type:"monotone",dataKey:"Spend",stroke:"#93C5FD",strokeWidth:3,fill:"url(#grad)"}),
                    h(Line,{type:"monotone",dataKey:"Jobs",stroke:"#A7F3D0",strokeWidth:2,dot:false})
                  )
                )
              )
            ),

            h("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6"},
              h("div",{className:"glass card-pad fadein chart"},
                h("h2",{className:"text-lg"},"Spend by Category"),
                h("div",{className:"h-64"},
                  h(ResponsiveContainer,{width:"100%",height:"100%"},
                    h(PieChart,null,
                      h(Tooltip,{contentStyle:{background:"rgba(12,16,27,0.9)",border:"none",borderRadius:12,color:"#E5E7EB"}}),
                      h(Pie,{data:metrics.categorySeries,dataKey:"value",nameKey:"name",innerRadius:60,outerRadius:90,paddingAngle:3},
                        metrics.categorySeries.map((_,i)=> h(Cell,{key:i,fill:`hsl(${200+i*14},80%,65%)`}))
                      ),
                      h(Legend,{wrapperStyle:{color:"#E5E7EB"},iconType:"circle"})
                    )
                  )
                )
              ),
              h("div",{className:"glass card-pad fadein chart lg:col-span-2"},
                h("h2",{className:"text-lg"},"Top Vendors"),
                h("div",{className:"h-64"},
                  h(ResponsiveContainer,{width:"100%",height:"100%"},
                    h(LineChart,{data:metrics.vendorSeries,margin:{top:0,right:0,left:0,bottom:0}},
                      h(XAxis,{dataKey:"name",tick:{fill:"#D1D5DB"},axisLine:false,tickLine:false,interval:0,angle:-20,textAnchor:"end",height:60}),
                      h(YAxis,{tick:{fill:"#D1D5DB"},axisLine:false,tickLine:false,width:72}),
                      h(Tooltip,{contentStyle:{background:"rgba(12,16,27,0.9)",border:"none",borderRadius:12,color:"#E5E7EB"}}),
                      h(Line,{type:"monotone",dataKey:"value",stroke:"#7DD3FC",strokeWidth:3,dot:{r:3}})
                    )
                  )
                )
              )
            ),

            h("div",{className:"glass card-pad fadein chart"},
              h("h2",{className:"text-lg"},"Most Frequent Units (Breakdowns)"),
              h("div",{className:"h-72"},
                h(ResponsiveContainer,{width:"100%",height:"100%"},
                  h(BarChart,{data:metrics.unitSeries,margin:{top:0,right:0,left:0,bottom:0},barCategoryGap:"20%",barGap:4},
                    h(XAxis,{dataKey:"name",tick:{fill:"#D1D5DB"},axisLine:false,tickLine:false,interval:0,angle:-20,textAnchor:"end",height:60}),
                    h(YAxis,{domain:[0,(max)=> typeof max==='number'? max+1 : 1],tick:{fill:"#D1D5DB"},axisLine:false,tickLine:false,width:72}),
                    h(Tooltip,{contentStyle:{background:"rgba(12,16,27,0.9)",border:"none",borderRadius:12,color:"#E5E7EB"}}),
                    h(Bar,{dataKey:"value",fill:"#93C5FD",radius:[10,10,0,0]})
                  )
                )
              )
            ),

            h("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6"},
              h("div",{className:"glass card-pad fadein"},
                h("div",{className:"text-lg"},"Open Reports"),
                h("div",{className:"overflow-x-auto mt-3"},
                  h("table",{className:"min-w-full text-sm"},
                    h("thead",{className:"text-white/70"},
                      h("tr",null,["Date","Unit","Category","Repair","Vendor","Total","Status"].map(th=>h("th",{key:th,className:"text-left pr-4 py-2"},th)))
                    ),
                    h("tbody",{className:"divide-y divide-white/10"},
                      metrics.openRows.map((r,i)=> h("tr",{key:"o-"+i,className:"hover:bg-white/5"},
                        ["Date","Unit","Category","Repair","Vendor","Total","Status"].map((k,ix)=> h("td",{key:ix,className:"pr-4 py-2"}, k==="Total" ? money(parseMoney(r[k])) : r[k] ))
                      )),
                      metrics.openRows.length===0 && h("tr",null,h("td",{colSpan:7,className:"py-4 text-white/60"},"No open reports"))
                    )
                  )
                )
              ),
              h("div",{className:"glass card-pad fadein"},
                h("div",{className:"text-lg"},"Closed Reports"),
                h("div",{className:"overflow-x-auto mt-3"},
                  h("table",{className:"min-w-full text-sm"},
                    h("thead",{className:"text-white/70"},
                      h("tr",null,["Date","Unit","Category","Repair","Vendor","Total","Status"].map(th=>h("th",{key:th,className:"text-left pr-4 py-2"},th)))
                    ),
                    h("tbody",{className:"divide-y divide-white/10"},
                      metrics.closedRows.map((r,i)=> h("tr",{key:"c-"+i,className:"hover:bg-white/5"},
                        ["Date","Unit","Category","Repair","Vendor","Total","Status"].map((k,ix)=> h("td",{key:ix,className:"pr-4 py-2"}, k==="Total" ? money(parseMoney(r[k])) : r[k] ))
                      )),
                      metrics.closedRows.length===0 && h("tr",null, h("td",{colSpan:7,className:"py-4 text-white/60"},"No closed reports"))
                    )
                  )
                )
              )
            )

          ))
        );
      }

      ReactDOM.createRoot(document.getElementById('app')).render(React.createElement(App));
    })();
  </script>
</body>
</html>
